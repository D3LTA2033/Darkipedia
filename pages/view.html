<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Paste - Darkipedia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="View your shared anonymous paste on Darkipedia.">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: var(--gray-darkest);
            color: var(--text-main);
            font-family: 'Fira Mono', 'Consolas', monospace;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: var(--gray-darker);
            border: 1px solid var(--gray-border);
            border-radius: var(--radius, 16px);
            max-width: 900px;
            min-width: 320px;
            margin: 3.2rem auto 2rem auto;
            box-shadow: var(--shadow);
            overflow: hidden;
            width: 100%;
            padding: 2.25rem 2.2rem 2.15rem 2.2rem;
            position: relative;
        }
        header {
            display: flex;
            align-items: center;
            padding: 1.35rem 2.1rem 1.15rem 2rem;
            background: var(--gray-dark);
            border-bottom: 1.5px solid var(--gray-border);
            justify-content: space-between;
            gap: 1.1em;
            position: relative;
            z-index: 2;
            border-radius: calc(var(--radius, 16px) - 3px) calc(var(--radius, 16px) - 3px) 0 0;
        }
        header h1 {
            color: var(--text-head);
            text-transform: lowercase;
            letter-spacing: 0.13em;
            font-size: 2.1rem;
            margin: 0;
            font-weight: 900;
            user-select: none;
            text-shadow: none;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        .to-home-btn {
            color: var(--green-link);
            background: var(--gray-accent);
            border: 1.1px solid var(--gray-border);
            border-radius: 4px;
            padding: 0.55em 1.12em;
            font-weight: 600;
            font-size: 1rem;
            margin-left: 1em;
            text-decoration: none;
            letter-spacing: 0.04em;
            outline: none;
            transition: background 0.13s, color 0.16s, border 0.18s;
            display: inline-block;
        }
        .to-home-btn:focus, .to-home-btn:hover {
            color: #262626;
            background: var(--green-link);
            border: 1.1px solid var(--brand-green);
        }
        main {
            padding: 2.1em 0 2.3em 0;
        }
        .paste-meta-bar {
            display: flex;
            align-items: center;
            gap: 1em;
            color: var(--brand-green);
            font-size: 1em;
            opacity: 0.98;
            margin-bottom: 1.1em;
            background: var(--gray-accent);
            border-radius: 6px;
            border: 1px solid var(--gray-border);
            padding: 0.6em 1.1em 0.6em 0.95em;
            box-shadow: 0 1px 10px #10131340;
            flex-wrap: wrap;
        }
        .paste-meta-bar .category {
            color: var(--brand-green);
            font-weight: 500;
            letter-spacing: 0.02em;
        }
        .paste-meta-bar .date {
            color: #ff83e3;
            font-size: 0.95em;
        }
        .paste-meta-bar .sep {
            color: var(--gray-medium);
        }
        .paste-content {
            background: var(--gray-dark);
            border-radius: 8px;
            border: 1.1px solid var(--gray-border);
            font-family: inherit;
            font-size: 1.13em;
            line-height: 1.8;
            padding: 1.22em 1.33em;
            color: var(--text-main);
            box-shadow: 0 1px 18px #10131355;
            margin-top: 2em;
            word-break: break-word;
            min-height: 7em;
            overflow-x: auto;
            transition: background 0.17s;
        }
        .paste-content img {
            display: block;
            max-width: 92vw;
            max-height: 450px;
            margin: 0.9em auto 0.9em auto;
            border-radius: 8px;
            box-shadow: 0 1px 14px #4ff66944, 0 0 2px #fff3;
            border: 1.1px solid var(--gray-border);
            background: var(--gray-light);
            transition: box-shadow 0.19s;
        }
        .paste-content a {
            color: var(--green-link);
            text-decoration: underline;
            word-break: break-all;
            transition: color .14s;
        }
        .paste-content a:hover,.paste-content a:focus{
            color: #fff83a;
            outline: none;
        }
        .paste-content pre {
            background: var(--gray-table-head);
            color: #fffaab;
            padding: 0.55em 0.7em;
            border-radius: 6px;
            margin: 1em 0;
            overflow-x: auto;
            font-size: 0.97em;
        }
        #not-found-message {
            display: none;
            color: #ff425f;
            font-weight: bold;
            background: #21141b;
            padding: 1.3em 1em;
            border-radius: 7px;
            border: 1.5px solid #3b1c27;
            margin-top: 2.5em;
            text-align: center;
            font-size: 1.19em;
            box-shadow: 0 1px 8px #ff4fce44;
        }
        /* Copy button styles */
        .copy-btn {
            background: var(--gray-accent);
            color: var(--brand-green);
            border: 1.1px solid var(--gray-medium);
            border-radius: 4px;
            padding: 0.34em 0.97em;
            font-size: 1em;
            margin-left: 1em;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            transition: background 0.13s, color 0.16s, border 0.18s;
        }
        .copy-btn:focus, .copy-btn:hover {
            background: var(--brand-green);
            color: #171e13;
            border: 1.1px solid var(--brand-green);
        }
        @media (max-width: 650px) {
            .container {
                max-width: 100vw;
                border-radius: 0;
                padding: 0.7rem 0 1.2rem 0;
            }
            main {
                padding: 1.1em 0.7em 2.1em 0.7em;
            }
            .paste-content {
                padding: 0.7em 0.7em;
            }
            .paste-meta-bar {
                flex-direction: column;
                align-items: flex-start;
                font-size: 0.97em;
                gap: 0.22em;
            }
            header {
                padding: 1.15em 0.6em 1em 1.05em;
                flex-direction: column;
                align-items: flex-start;
            }
            header h1 {
                font-size: 1.16em;
            }
            .to-home-btn {
                font-size: 1em;
                padding: 0.5em 0.85em;
                margin-left: 0;
                margin-top: 0.55em;
            }
            .paste-content img {
                max-width: 99vw;
                max-height: 220px;
            }
            .copy-btn {
                margin: 1.1em 0 0 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="paste-title" aria-live="polite">Loading...</h1>
            <div style="display:flex;align-items:center;gap:.4em;">
                <button class="copy-btn" id="copy-link" type="button" title="Copy link to this paste" aria-label="Copy Link">
                    ðŸ“‹ Copy Link
                </button>
                <a href="../index.html" class="to-home-btn" title="Back to Home">&larr; Home</a>
            </div>
        </header>
        <main>
            <div class="paste-meta-bar" id="paste-meta" aria-live="polite">
                <span id="paste-category" class="category"></span>
                <span class="sep" aria-hidden="true">|</span>
                <span id="paste-date" class="date"></span>
            </div>
            <article id="paste-content" class="paste-content" tabindex="0">
                <!-- Content will appear here -->
            </article>
            <div id="not-found-message" role="alert">Paste not found.</div>
        </main>
    </div>
    <script>
        // --- Utility Functions ---
        function getParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Basic image URL detector
        function isImageUrl(url) {
            return /^https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?[^ \n]*)?$/i.test(url);
        }

        // --- Rich Content Renderer ---
        function renderContent(text) {
            if (!text) return '<em style="color:#ff4ffe;">No content.</em>';
            function escapeHtml(str) {
                return str.replace(/[&<>"']/g, m => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[m]));
            }

            // Markdown-style code fences and automatic link/image
            let html = '';
            const lines = text.split('\n');
            let inCode = false;
            let codeBuffer = [];
            for (let i = 0; i < lines.length; ++i) {
                let ln = lines[i];

                // Code block start/end
                if (ln.trim().startsWith('```')) {
                    if (inCode) {
                        html += '<pre>' + escapeHtml(codeBuffer.join('\n')) + '</pre>';
                        codeBuffer = [];
                        inCode = false;
                    } else {
                        inCode = true;
                    }
                    continue;
                }
                if (inCode) {
                    codeBuffer.push(ln);
                    continue;
                }

                // Markdown image: ![alt](url)
                let imgMd = ln.match(/!\[([^\]]*)\]\((https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|bmp|webp|svg)[^\)]*)\)/i);
                if (imgMd) {
                    html += `<img src="${imgMd[2]}" alt="${escapeHtml(imgMd[1])}">`;
                    if (ln.replace(imgMd[0], '').trim()) {
                        html += '<br>' + escapeHtml(ln.replace(imgMd[0], ''));
                    }
                    continue;
                }
                // Image URL on its own line
                if (isImageUrl(ln.trim())) {
                    html += `<img src="${ln.trim()}" alt="pasted image">`;
                    continue;
                }
                // Auto-link URLs (do not relink image lines)
                ln = ln.replace(/(https?:\/\/[^\s<>"']+)/g, url => {
                    if (isImageUrl(url)) {
                        return `<img src="${url}" alt="pasted image">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
                });
                // Preserve whitespace & breaks
                html += escapeHtml(ln).replace(/ {2}/g, '&nbsp; ') + '<br>';
            }
            if (inCode && codeBuffer.length) {
                html += '<pre>' + escapeHtml(codeBuffer.join('\n')) + '</pre>';
            }
            return html.replace(/<br>$/, '');
        }

        // --- Paste Display Logic ---
        function displayPaste(paste) {
            const titleText = paste.title && paste.title.trim() ? paste.title.trim() : `Untitled Paste (${paste.id})`;
            document.getElementById('paste-title').textContent = titleText;
            document.getElementById('paste-category').textContent = paste.category ? paste.category : 'Uncategorized';

            let dateStr = 'Unknown';
            if (paste.date) {
                const date = new Date(paste.date);
                if (!isNaN(date.valueOf())) dateStr = date.toLocaleString();
            }
            document.getElementById('paste-date').textContent = dateStr;

            let contentHtml = '';
            if (paste.content && paste.content.trim() !== '') {
                contentHtml = renderContent(paste.content);
            } else {
                contentHtml = '<em style="color:#ff4ffe;">No content.</em>';
            }
            document.getElementById('paste-content').innerHTML = contentHtml;
        }

        // --- Copy Link Feature ---
        document.addEventListener('DOMContentLoaded', function() {
            const copyBtn = document.getElementById('copy-link');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    navigator.clipboard.writeText(window.location.href)
                        .then(() => {
                            copyBtn.textContent = "âœ… Link Copied!";
                            setTimeout(() => {
                                copyBtn.textContent = "ðŸ“‹ Copy Link";
                            }, 1200);
                        })
                        .catch(() => {
                            copyBtn.textContent = "âŒ Copy Failed!";
                            setTimeout(() => {
                                copyBtn.textContent = "ðŸ“‹ Copy Link";
                            }, 1300);
                        });
                });
            }
        });

        // --- Entry Point ---
        (function() {
            const id = getParam('id');
            const notFoundMsg = document.getElementById('not-found-message');
            const metaBar = document.getElementById('paste-meta');
            const contentArt = document.getElementById('paste-content');
            const titleEl = document.getElementById('paste-title');

            // Defensive: Hide all
            function hideEverythingNotFound() {
                notFoundMsg.style.display = 'block';
                titleEl.textContent = 'Paste Not Found';
                metaBar.style.display = 'none';
                contentArt.style.display = 'none';
            }

            if (!id) {
                hideEverythingNotFound();
                return;
            }
            let pastes = [];
            // Safer fallback for backwards compatibility
            try {
                pastes = JSON.parse(localStorage.getItem('darkipedia_pastes')) || [];
            } catch(e) { pastes = []; }
            if (!pastes.length) {
                try {
                    pastes = JSON.parse(localStorage.getItem('pastes')) || [];
                } catch(e) { pastes = []; }
            }
            const paste = pastes.find(p => String(p.id) === String(id));
            if (paste) {
                metaBar.style.display = '';
                contentArt.style.display = '';
                notFoundMsg.style.display = 'none';
                displayPaste(paste);
            } else {
                hideEverythingNotFound();
            }
        })();
    </script>
</body>
</html>
