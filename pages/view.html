<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Paste - Darkipedia</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: var(--gray-darkest);
            color: var(--text-main);
            font-family: 'Fira Mono', 'Consolas', monospace;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: var(--gray-darker);
            border: 1px solid var(--gray-border);
            border-radius: var(--radius);
            max-width: 900px;
            min-width: 320px;
            margin: 3.2rem 0 2rem;
            box-shadow: var(--shadow);
            overflow: hidden;
            width: 100%;
            padding: 2.25rem 2.2rem 2.15rem 2.2rem;
            position: relative;
        }
        header {
            display: flex;
            align-items: center;
            padding: 1.35rem 2.1rem 1.15rem 2rem;
            background: var(--gray-dark);
            border-bottom: 1.5px solid var(--gray-border);
            box-shadow: none;
            justify-content: space-between;
            gap: 1.1em;
            position: relative;
            z-index: 2;
            border-radius: calc(var(--radius) - 3px) calc(var(--radius) - 3px) 0 0;
        }
        header h1 {
            color: var(--text-head);
            text-transform: lowercase;
            letter-spacing: 0.13em;
            font-size: 2.1rem;
            margin: 0;
            font-weight: 900;
            user-select: none;
            text-shadow: none;
        }
        .to-home-btn {
            color: var(--green-link);
            background: var(--gray-accent);
            border: 1.1px solid var(--gray-border);
            border-radius: 4px;
            padding: 0.55em 1.12em;
            font-weight: 600;
            font-size: 1rem;
            margin-left: 1em;
            text-decoration: none;
            letter-spacing: 0.04em;
            outline: none;
            transition: background 0.13s, color 0.16s, border 0.18s;
            display: inline-block;
        }
        .to-home-btn:hover, .to-home-btn:focus {
            color: #333;
            background: var(--green-link);
            border: 1.1px solid var(--brand-green);
        }
        main {
            padding: 2.1em 0 2.3em 0;
        }
        .paste-meta-bar {
            display: flex;
            align-items: center;
            gap: 1em;
            color: var(--brand-green);
            font-size: 1em;
            opacity: 0.98;
            margin-bottom: 1.1em;
            background: var(--gray-accent);
            border-radius: 6px;
            border: 1px solid var(--gray-border);
            padding: 0.6em 1.1em 0.6em 0.95em;
            box-shadow: 0 1px 10px #10131340;
        }
        .paste-meta-bar .category {
            color: var(--brand-green);
            font-weight: 500;
            letter-spacing: 0.02em;
        }
        .paste-meta-bar .date {
            color: #ff83e3;
            font-size: 0.95em;
        }
        .paste-meta-bar .sep {
            color: var(--gray-medium);
        }
        .paste-content {
            background: var(--gray-dark);
            border-radius: 8px;
            border: 1.1px solid var(--gray-border);
            font-family: inherit;
            font-size: 1.13em;
            line-height: 1.8;
            padding: 1.22em 1.33em;
            color: var(--text-main);
            box-shadow: 0 1px 18px #10131355;
            margin-top: 2em;
            word-break: break-word;
            min-height: 7em;
            overflow-x: auto;
        }
        .paste-content img {
            display: block;
            max-width: 92vw;
            max-height: 450px;
            margin: 0.9em auto 0.9em auto;
            border-radius: 8px;
            box-shadow: 0 1px 14px #4ff66944, 0 0 2px #fff3;
            border: 1.1px solid var(--gray-border);
            background: var(--gray-light);
        }
        .paste-content a {
            color: var(--green-link);
            text-decoration: underline;
            word-break: break-all;
        }
        .paste-content pre {
            background: var(--gray-table-head);
            color: #fffaab;
            padding: 0.55em 0.7em;
            border-radius: 6px;
            margin: 1em 0;
            overflow-x: auto;
            font-size: 0.97em;
        }
        #not-found-message {
            display: none;
            color: #ff425f;
            font-weight: bold;
            background: #21141b;
            padding: 1.3em 1em;
            border-radius: 7px;
            border: 1.5px solid #3b1c27;
            margin-top: 2.5em;
            text-align: center;
            font-size: 1.19em;
            box-shadow: 0 1px 8px #ff4fce44;
        }
        @media (max-width: 650px) {
            .container {
                max-width: 100vw;
                border-radius: 0;
                padding: 0.7rem 0 1.2rem 0;
            }
            main {
                padding: 1.1em 0.7em 2.1em 0.7em;
            }
            .paste-content {
                padding: 0.7em 0.7em;
            }
            .paste-meta-bar {
                flex-direction: column;
                align-items: flex-start;
                font-size: 0.98em;
                gap: 0.25em;
            }
            header {
                padding: 1.15em 0.6em 1em 1.05em;
                flex-direction: column;
                align-items: flex-start;
            }
            header h1 {
                font-size: 1.23em;
            }
            .to-home-btn {
                font-size: 1em;
                padding: 0.5em 0.85em;
                margin-left: 0;
                margin-top: 0.55em;
            }
            .paste-content img {
                max-width: 99vw;
                max-height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="paste-title">Loading...</h1>
            <a href="../index.html" class="to-home-btn">&larr; Back to Home</a>
        </header>
        <main>
            <div class="paste-meta-bar" id="paste-meta">
                <span id="paste-category" class="category"></span>
                <span class="sep">|</span>
                <span id="paste-date" class="date"></span>
            </div>
            <article id="paste-content" class="paste-content">
                <!-- Content will appear here -->
            </article>
            <div id="not-found-message">Paste not found.</div>
        </main>
    </div>
    <script>
        // Utility: Get param from URL
        function getParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Helper: very basic image URL detector (http/https and ends with image extension)
        function isImageUrl(url) {
            return /^https?:\/\/[^ \n]+?\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?[^ \n]*)?$/i.test(url);
        }

        // Auto-link and allow images in paste content
        function renderContent(text) {
            if (!text) return '<em style="color:#ff4ffe;">No content.</em>';
            // Escape HTML
            function escapeHtml(str) {
                return str.replace(/[&<>"']/g, function(m) {
                    return ({
                        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                    })[m];
                });
            }
            // Handle code blocks (```markdown syntax)
            let html = '';
            const lines = text.split('\n');
            let inCode = false;
            let codeBuffer = [];
            for (let i = 0; i < lines.length; ++i) {
                let ln = lines[i];
                if (ln.trim().startsWith('```')) {
                    if (inCode) {
                        html += '<pre>' + escapeHtml(codeBuffer.join('\n')) + '</pre>';
                        codeBuffer = [];
                        inCode = false;
                    } else {
                        inCode = true;
                    }
                    continue;
                }
                if (inCode) {
                    codeBuffer.push(ln);
                    continue;
                }
                // Auto-image: Markdown ![alt](url)
                let imgMd = ln.match(/!\[([^\]]*)\]\((https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|bmp|webp|svg)[^\)]*)\)/i);
                if (imgMd) {
                    html += `<img src="${imgMd[2]}" alt="${escapeHtml(imgMd[1])}">`;
                    if (ln.replace(imgMd[0], '').trim()) {
                        html += '<br>' + escapeHtml(ln.replace(imgMd[0], ''));
                    }
                    continue;
                }
                // Auto-image: Image URL on its own line
                if (isImageUrl(ln.trim())) {
                    html += `<img src="${ln.trim()}" alt="pasted image">`;
                    continue;
                }
                // Auto-link URLs (don't re-link image lines)
                ln = ln.replace(/(https?:\/\/[^\s<>"']+)/g, function(url) {
                    if (isImageUrl(url)) {
                        return `<img src="${url}" alt="pasted image">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(url)}</a>`;
                });
                // Preserve whitespace and line breaks
                html += escapeHtml(ln).replace(/ {2}/g, '&nbsp; ') + '<br>';
            }
            // If code block unclosed, flush
            if (inCode && codeBuffer.length) {
                html += '<pre>' + escapeHtml(codeBuffer.join('\n')) + '</pre>';
            }
            return html.replace(/<br>$/,''); // Remove last <br>
        }

        // Display paste info
        function displayPaste(paste) {
            document.getElementById('paste-title').textContent = paste.title && paste.title.trim() ? paste.title : `Untitled Paste (${paste.id})`;
            document.getElementById('paste-category').textContent = paste.category ? paste.category : 'Uncategorized';

            // Assume paste.date exists; if not, show Unknown
            let dateStr = 'Unknown';
            if (paste.date) {
                const date = new Date(paste.date);
                if (!isNaN(date)) {
                    dateStr = date.toLocaleString();
                }
            }
            document.getElementById('paste-date').textContent = dateStr;

            // Allow images and links in content
            let contentHtml = '';
            if (paste.content && paste.content.trim() !== '') {
                contentHtml = renderContent(paste.content);
            } else {
                contentHtml = '<em style="color:#ff4ffe;">No content.</em>';
            }
            document.getElementById('paste-content').innerHTML = contentHtml;
        }

        // Entry point
        (function() {
            const id = getParam('id');
            const notFoundMsg = document.getElementById('not-found-message');
            const metaBar = document.getElementById('paste-meta');
            const contentArt = document.getElementById('paste-content');
            const titleEl = document.getElementById('paste-title');
            if (!id) {
                notFoundMsg.style.display = 'block';
                titleEl.textContent = 'Paste Not Found';
                metaBar.style.display = 'none';
                contentArt.style.display = 'none';
                return;
            }
            let pastes = [];
            try {
                pastes = JSON.parse(localStorage.getItem('darkipedia_pastes')) || JSON.parse(localStorage.getItem('pastes')) || [];
            } catch(e) {
                pastes = [];
            }
            const paste = pastes.find(p => String(p.id) === String(id));
            if (paste) {
                displayPaste(paste);
            } else {
                notFoundMsg.style.display = 'block';
                titleEl.textContent = 'Paste Not Found';
                metaBar.style.display = 'none';
                contentArt.style.display = 'none';
            }
        })();
    </script>
</body>
</html>
