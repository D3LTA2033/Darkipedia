<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Paste - Darkipedia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="View your shared anonymous paste on Darkipedia.">
    <!-- Style imports similar to index.html -->
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --main-bg: #131616;
            --box-bg: #191e1c;
            --border: #1e2123;
            --accent-bg: #171a19;
            --brand: #50fc7f;
            --accent-pink: #ff60e6;
            --yellow: #fff83a;
            --red: #ff5667;
            --border-radius: 13px;
            --shadow: 0 4px 24px #02110593;
        }
        body {
            margin: 0;
            font-family: 'Fira Mono', 'Consolas', monospace;
            background: var(--main-bg);
            color: #eeeeee;
            min-height: 100vh;
            letter-spacing: 0.01em;
            scroll-behavior: smooth;
        }
        .container {
            margin: 2.7rem auto 0 auto;
            background: var(--box-bg);
            border: 1.15px solid var(--border);
            border-radius: var(--border-radius);
            max-width: 780px;
            min-width: 320px;
            width: 95vw;
            box-shadow: var(--shadow);
            padding: 1.7rem 1.6rem 1.2rem 1.6rem;
            position: relative;
            overflow: hidden;
        }
        header {
            background: var(--accent-bg);
            border-bottom: 1.3px solid var(--border);
            border-radius: calc(var(--border-radius) - 2.5px) calc(var(--border-radius) - 2.5px) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.2em;
            padding: 1.09rem 1.29rem 1rem 1.08rem;
            position: relative;
            z-index: 2;
        }
        header h1 {
            color: var(--brand);
            font-size: 2.0rem;
            margin: 0;
            font-weight: 900;
            letter-spacing: 0.14em;
            display: flex;
            align-items: center;
            gap: 0.49em;
            user-select: none;
            text-transform: lowercase;
        }
        .material-icons {
            font-size: 1.16em;
            vertical-align: middle;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.42em;
        }
        .to-home-btn {
            color: var(--brand);
            background: none;
            border: 1.1px solid var(--border);
            border-radius: 6px;
            padding: 0.5em 1.08em;
            font-weight: 800;
            font-size: 1.04rem;
            margin-left: 1em;
            text-decoration: none;
            letter-spacing: 0.04em;
            outline: none;
            transition: 
                background 0.12s,
                border 0.13s,
                color 0.14s,
                box-shadow 0.13s;
            display: inline-block;
        }
        .to-home-btn:focus, .to-home-btn:hover {
            background: var(--brand);
            color: #121d13;
            border: 1.3px solid var(--brand);
            box-shadow: 0 2px 10px #72ff9412;
        }
        main {
            padding: 2em 0 2.3em 0;
        }
        .paste-meta-bar {
            display: flex;
            align-items: center;
            gap: 1.1em;
            color: var(--brand);
            font-size: 1em;
            margin-bottom: 1.14em;
            background: #161b19;
            border-radius: 7px;
            border: 1px solid var(--border);
            padding: 0.58em 1.03em 0.65em 1em;
            box-shadow: 0 1px 8px #12281636;
            flex-wrap: wrap;
        }
        .paste-meta-bar .category {
            color: var(--brand);
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        .paste-meta-bar .date {
            color: var(--accent-pink);
            font-size: 0.97em;
            margin-left: 0.32em;
        }
        .paste-meta-bar .sep {
            color: #37614b;
        }
        .paste-content {
            background: #191e1c;
            border-radius: 9px;
            border: 1.2px solid var(--border);
            font-size: 1.15em;
            line-height: 1.75;
            padding: 1.08em 1.15em;
            color: #d6ffe3;
            box-shadow: 0 1px 14px #22db7625;
            margin-top: 2em;
            min-height: 7em;
            overflow-x: auto;
        }
        .paste-content img {
            display: block;
            max-width: 93vw;
            max-height: 420px;
            margin: 1em auto;
            border-radius: 8px;
            box-shadow: 0 1px 8px #50fc7f37;
            border: 1px solid var(--border);
            background: #222725;
            transition: box-shadow 0.19s;
            object-fit: contain;
        }
        .paste-content a {
            color: var(--brand);
            text-decoration: underline;
            transition: color .11s;
            word-break: break-all;
        }
        .paste-content a:hover,
        .paste-content a:focus {
            color: var(--yellow);
            outline: none;
        }
        .paste-content pre {
            background: #151b16;
            color: #e3faaf;
            padding: 0.63em 0.78em;
            border-radius: 5px;
            margin: 0.85em 0;
            overflow-x: auto;
            font-size: 0.99em;
            font-family: 'Fira Mono', 'Consolas', monospace;
        }
        #not-found-message {
            display: none;
            color: var(--red);
            font-weight: bold;
            background: #241017;
            padding: 1.19em 1em;
            border-radius: 8px;
            border: 1.7px solid #3b1632;
            margin-top: 2.2em;
            text-align: center;
            font-size: 1.18em;
            box-shadow: 0 1px 8px #ff4fce42;
            animation: fadein-notfound 0.8s;
        }
        @keyframes fadein-notfound {
            from { opacity: 0; transform: scale(0.98);}
            to { opacity: 1; transform: scale(1);}
        }

        .copy-btn {
            background: #161b19;
            color: var(--brand);
            border: 1.2px solid #2a4132;
            border-radius: 5px;
            padding: 0.38em 1.05em;
            font-size: 1.06em;
            margin-left: 1em;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: 
                background 0.13s, 
                color 0.15s, 
                border 0.16s, 
                box-shadow 0.12s;
            display: flex;
            align-items: center;
            gap: 0.37em;
        }
        .copy-btn:focus, .copy-btn:hover {
            background: var(--brand);
            color: #14211a;
            border: 1.3px solid var(--brand);
            box-shadow: 0 2px 9px #50fc7f2e;
        }
        .copy-btn .material-icons {
            font-size: 1.12em;
        }

        /* Responsive improvements */
        @media (max-width: 650px) {
            .container {
                max-width: 100vw;
                border-radius: 0;
                padding: 0.6rem 0 1.1rem 0;
            }
            main {
                padding: 1em 0.6em 1.5em 0.6em;
            }
            .paste-content {
                padding: 0.7em 0.7em;
                font-size: 0.99em;
            }
            .paste-meta-bar {
                flex-direction: column;
                align-items: flex-start;
                font-size: 0.98em;
                gap: 0.19em;
                padding: 0.56em 0.66em;
            }
            header {
                padding: 0.93em 0.4em 0.83em 0.93em;
                flex-direction: column;
                align-items: flex-start;
            }
            header h1 {
                font-size: 1.20em;
                word-break: break-word;
            }
            .to-home-btn {
                font-size: 1em;
                padding: 0.46em 0.8em;
                margin-left: 0;
                margin-top: 0.53em;
            }
            .paste-content img {
                max-width: 98vw;
                max-height: 170px;
            }
            .copy-btn {
                margin: 1em 0 0 0;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="paste-title" aria-live="polite">
                <span class="material-icons" aria-hidden="true" style="color:var(--brand);">description</span>
                Loading...
            </h1>
            <div class="header-actions">
                <button class="copy-btn" id="copy-link" type="button" title="Copy link to this paste" aria-label="Copy Link">
                    <span class="material-icons" aria-hidden="true">link</span> Copy Link
                </button>
                <a href="../index.html" class="to-home-btn" title="Back to Home">
                    <span class="material-icons" style="vertical-align:-3px" aria-hidden="true">arrow_back</span>
                    Home
                </a>
            </div>
        </header>
        <main>
            <div class="paste-meta-bar" id="paste-meta" aria-live="polite">
                <span id="paste-category" class="category"></span>
                <span class="sep" aria-hidden="true">|</span>
                <span id="paste-date" class="date"></span>
            </div>
            <article id="paste-content" class="paste-content" tabindex="0" aria-label="Paste content" aria-live="polite">
                <!-- Content will appear here -->
            </article>
            <div id="not-found-message" role="alert">
                <span class="material-icons" aria-hidden="true" style="vertical-align:middle;font-size:1.18em;margin-right:0.21em;">error_outline</span>
                Paste not found.
            </div>
        </main>
    </div>
    <script>
        // --- Utility Functions ---
        function getParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Improved image extension check (allows query strings and fragments)
        function isImageUrl(url) {
            return /^https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|bmp|webp|svg)([?#][^\s]*)?$/i.test(url);
        }

        // --- Rich Content Renderer ---
        function renderContent(text) {
            if (!text) return '<em style="color:' + (getComputedStyle(document.body).getPropertyValue('--accent-pink') || "#ff4ffe") + ';">No content.</em>';
            function escapeHtml(str) {
                return str.replace(/[&<>"']/g, m => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[m]));
            }
            let html = '';
            const lines = text.split('\n');
            let inCode = false;
            let codeBuffer = [];
            for (let i = 0; i < lines.length; ++i) {
                let ln = lines[i];

                // Code block start/end
                if (ln.trim().startsWith('```')) {
                    if (inCode) {
                        html += '<pre>' + escapeHtml(codeBuffer.join('\n')) + '</pre>';
                        codeBuffer = [];
                        inCode = false;
                    } else {
                        inCode = true;
                    }
                    continue;
                }
                if (inCode) {
                    codeBuffer.push(ln);
                    continue;
                }

                // Markdown image: ![alt](url)
                let imgMd = ln.match(/!\[([^\]]*)\]\((https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|bmp|webp|svg)[^\)]*)\)/i);
                if (imgMd) {
                    html += `<img src="${imgMd[2]}" alt="${escapeHtml(imgMd[1])}">`;
                    const rest = ln.replace(imgMd[0], '').trim();
                    if (rest) {
                        html += '<br>' + escapeHtml(rest);
                    }
                    continue;
                }
                // Image URL on its own line
                if (isImageUrl(ln.trim())) {
                    html += `<img src="${ln.trim()}" alt="pasted image">`;
                    continue;
                }
                // Markdown-style links: [text](url)
                ln = ln.replace(/\[([^\]]+)]\((https?:\/\/[^\s)]+)\)/g, (m, text, url) => {
                    if (isImageUrl(url)) {
                        return `<img src="${url}" alt="${escapeHtml(text)}">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(text)}</a>`;
                });
                // Autolink URLs (avoid double-linking images)
                ln = ln.replace(/(https?:\/\/[^\s<>"'()]+)/g, url => {
                    if (isImageUrl(url)) {
                        return `<img src="${url}" alt="pasted image">`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
                });
                // Basic **bold** & *italic*
                ln = ln.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                ln = ln.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                // Preserve whitespace & breaks
                html += escapeHtml(ln).replace(/ {2}/g, '&nbsp; ') + '<br>';
            }
            if (inCode && codeBuffer.length) {
                html += '<pre>' + escapeHtml(codeBuffer.join('\n')) + '</pre>';
            }
            return html.replace(/<br>$/, '');
        }

        // --- Paste Display Logic ---
        function displayPaste(paste) {
            const titleText = paste.title && paste.title.trim() ? paste.title.trim() : `Untitled Paste (${paste.id})`;
            const titleIcon = document.createElement('span');
            titleIcon.className = "material-icons";
            titleIcon.style.color = getComputedStyle(document.body).getPropertyValue('--brand') || "#51ff8d";
            titleIcon.textContent = "description";
            const titleEl = document.getElementById('paste-title');
            // Remove previous icon
            while (titleEl.firstChild) titleEl.removeChild(titleEl.firstChild);
            titleEl.appendChild(titleIcon);
            titleEl.append(' ', titleText);

            document.getElementById('paste-category').textContent = paste.category ? paste.category : 'Uncategorized';

            let dateStr = 'Unknown';
            if (paste.date) {
                const date = new Date(paste.date);
                if (!isNaN(date.valueOf())) dateStr = date.toLocaleString();
            }
            document.getElementById('paste-date').textContent = dateStr;

            const contentHtml = paste.content && paste.content.trim() !== ''
                ? renderContent(paste.content)
                : '<em style="color:' + (getComputedStyle(document.body).getPropertyValue('--accent-pink') || "#ff4ffe") + ';">No content.</em>';
            document.getElementById('paste-content').innerHTML = contentHtml;
        }

        // --- Copy Link Feature ---
        document.addEventListener('DOMContentLoaded', function() {
            const copyBtn = document.getElementById('copy-link');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    navigator.clipboard.writeText(window.location.href)
                        .then(() => {
                            copyBtn.innerHTML = '<span class="material-icons" aria-hidden="true" style="color:'+(getComputedStyle(document.body).getPropertyValue('--brand')||'#22e855')+';">check_circle</span> Link Copied!';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<span class="material-icons" aria-hidden="true">link</span> Copy Link';
                            }, 1300);
                        })
                        .catch(() => {
                            copyBtn.innerHTML = '<span class="material-icons" aria-hidden="true" style="color:'+(getComputedStyle(document.body).getPropertyValue('--red')||'#ff5370')+';">error</span> Copy Failed!';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<span class="material-icons" aria-hidden="true">link</span> Copy Link';
                            }, 1500);
                        });
                });
            }
        });

        // --- Keyboard accessibility (focus paste content on load) ---
        window.addEventListener('DOMContentLoaded', function () {
            const article = document.getElementById('paste-content');
            if (article) {
                setTimeout(() => article.focus(), 180);
            }
        });

        // --- Entry Point ---
        (function() {
            const id = getParam('id');
            const notFoundMsg = document.getElementById('not-found-message');
            const metaBar = document.getElementById('paste-meta');
            const contentArt = document.getElementById('paste-content');
            const titleEl = document.getElementById('paste-title');

            function hideEverythingNotFound() {
                notFoundMsg.style.display = 'block';
                titleEl.innerHTML = '<span class="material-icons" style="color:'+ (getComputedStyle(document.body).getPropertyValue('--red')||'#ff5f90') +';vertical-align:middle;">highlight_off</span> Paste Not Found';
                metaBar.style.display = 'none';
                contentArt.style.display = 'none';
            }

            if (!id) {
                hideEverythingNotFound();
                return;
            }
            let pastes = [];
            // Use new, fallback to old
            try { pastes = JSON.parse(localStorage.getItem('darkipedia_pastes')) || []; } catch {}
            if (!Array.isArray(pastes) || !pastes.length) {
                try { pastes = JSON.parse(localStorage.getItem('pastes')) || []; } catch {}
            }
            if (!Array.isArray(pastes)) pastes = [];
            const paste = pastes.find(p => String(p.id) === String(id));
            if (paste) {
                metaBar.style.display = '';
                contentArt.style.display = '';
                notFoundMsg.style.display = 'none';
                displayPaste(paste);
            } else {
                hideEverythingNotFound();
            }
        })();
    </script>
</body>
</html>
